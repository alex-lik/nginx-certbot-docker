# nginx + certbot (Docker, minimal)

Минимальный и предсказуемый стек для HTTPS в Docker без nginx-proxy-manager и UI.

Особенности:
- nginx:alpine (~50 MB)
- certbot в отдельном контейнере
- автоматическое получение и продление сертификатов
- поддержка нескольких доменов
- DNS-проверка перед выпуском
- dry-run режим (без траты лимитов Let’s Encrypt)
- конфиги под контролем Git
- без Web UI, без магии, без лишнего

Подходит для VPS, production и инфраструктуры «один раз настроил — забыл».

---

## Структура проекта

```
.
├── docker-compose.yml
├── manage_domains.sh
├── domains.txt
├── nginx/
│   ├── nginx.conf
│   └── conf.d/
│       ├── domain.http.conf.tpl
│       ├── domain.https.conf.tpl
│       └── *.conf        # генерируются автоматически
├── certbot/
│   ├── conf/             # сертификаты (НЕ коммитятся)
│   └── www/              # webroot для ACME
└── .gitignore
```

---

## Требования

- Docker
- Docker Compose
- Открытые порты:
  - 80/tcp
  - 443/tcp
- DNS A-записи доменов должны указывать на IP сервера

---

## Быстрый старт

### 1. Создать docker-сеть (один раз)

```bash
docker network create proxy
```

---

### 2. Запустить nginx + certbot

```bash
docker compose up -d
```

Контейнер `certbot` будет постоянно работать и каждые 12 часов проверять необходимость продления сертификатов.

---

### 3. Описать домены

Файл `domains.txt`:

```txt
ketrn.com;ketrn_frontend:3000
api.ketrn.com;ketrn_backend:8000
admin.ketrn.com;ketrn_adminer:8080
```

Формат:
```
домен;docker_container:port
```

Все контейнеры должны быть в сети `proxy`.

---

### 4. Тестовый прогон (dry-run)

Рекомендуется перед первым боевым запуском.

```bash
./manage_domains.sh --dry-run
```

- сертификаты не выпускаются
- лимиты Let’s Encrypt не тратятся
- проверяется DNS и HTTP-доступность

---

### 5. Боевой запуск (один раз)

```bash
./manage_domains.sh
```

Скрипт:
1. генерирует HTTP-only конфиг
2. проверяет доступность домена
3. выпускает сертификат
4. переключает nginx на HTTPS
5. перезапускает nginx

После этого к теме сертификатов возвращаться не нужно.

---

## Как работает продление сертификатов

- контейнер `certbot` запущен постоянно
- каждые 12 часов выполняется `certbot renew`
- сертификаты обновляются **только если до окончания ≤ 30 дней**
- в остальное время certbot ничего не делает
- сертификаты хранятся в volume (`certbot/conf`)
- nginx использует те же файлы

Это стандартная и рекомендованная схема Let’s Encrypt.

---

## Безопасность

- приватные ключи и сертификаты **не коммитятся**
- `.gitignore` уже настроен
- nginx отключает `server_tokens`
- базовые security headers включены
- rate-limit включён

---

## Что это НЕ делает

- нет Web UI
- нет автоматического обнаружения контейнеров
- нет «клик-клик»

Это осознанный DevOps-подход: контроль, простота, воспроизводимость.

---

## Когда стоит использовать wildcard

Wildcard (`*.example.com`) имеет смысл, если:
- много динамических поддоменов
- частое добавление новых сервисов

Для этого нужен DNS-01 challenge и API DNS-провайдера (например, Cloudflare).  
В текущем проекте используется HTTP-01 — проще и надёжнее для статичных доменов.

---

## Лицензия

MIT / use at your own risk.

---

## Автор

Oleksii Likanov  
DevOps / Backend / Infrastructure

